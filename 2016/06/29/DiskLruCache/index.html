<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>UIL之DiskLruCache 源码分析 | smallsilver&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="##LRU是Least Recently Used 近期最少使用算法。
内存管理的一种页面置换算法，对于在内存中但又不用的数据块（内存块）叫做LRU，操作系统会根据哪些数据属于LRU而将其移出内存而腾出空间来加载另外的数据。    什么是LRU算法？ LRU是Least Recently Used的缩写，即最近最少使用，常用于页面置换算法，是为虚拟页式存储管理服务的。关于操作系统的内存管理，如何节">
<meta property="og:type" content="article">
<meta property="og:title" content="UIL之DiskLruCache 源码分析">
<meta property="og:url" content="http://wangdongen.cn/2016/06/29/DiskLruCache/index.html">
<meta property="og:site_name" content="smallsilver's blog">
<meta property="og:description" content="##LRU是Least Recently Used 近期最少使用算法。
内存管理的一种页面置换算法，对于在内存中但又不用的数据块（内存块）叫做LRU，操作系统会根据哪些数据属于LRU而将其移出内存而腾出空间来加载另外的数据。    什么是LRU算法？ LRU是Least Recently Used的缩写，即最近最少使用，常用于页面置换算法，是为虚拟页式存储管理服务的。关于操作系统的内存管理，如何节">
<meta property="og:updated_time" content="2016-06-29T15:42:19.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="UIL之DiskLruCache 源码分析">
<meta name="twitter:description" content="##LRU是Least Recently Used 近期最少使用算法。
内存管理的一种页面置换算法，对于在内存中但又不用的数据块（内存块）叫做LRU，操作系统会根据哪些数据属于LRU而将其移出内存而腾出空间来加载另外的数据。    什么是LRU算法？ LRU是Least Recently Used的缩写，即最近最少使用，常用于页面置换算法，是为虚拟页式存储管理服务的。关于操作系统的内存管理，如何节">
  
    <link rel="alternate" href="/atom.xml" title="smallsilver&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-79606812-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">smallsilver&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
	<!--
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
        -->
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://wangdongen.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-DiskLruCache" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/29/DiskLruCache/" class="article-date">
  <time datetime="2016-06-29T13:51:31.000Z" itemprop="datePublished">2016-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      UIL之DiskLruCache 源码分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>##LRU是Least Recently Used 近期最少使用算法。</p>
<p>内存管理的一种页面置换算法，对于在内存中但又不用的数据块（内存块）叫做LRU，操作系统会根据哪些数据属于LRU而将其移出内存而腾出空间来加载另外的数据。<br>    什么是LRU算法？ LRU是Least Recently Used的缩写，即最近最少使用，常用于页面置换算法，是为虚拟页式存储管理服务的。<br>关于操作系统的内存管理，如何节省利用容量不大的内存为最多的进程提供资源，一直是研究的重要方向。而内存的虚拟存储管理，是现在最通用，最成功的方式—— 在内存有限的情况下，扩展一部分外存作为虚拟内存，真正的内存只存储当前运行时所用得到信息。这无疑极大地扩充了内存的功能，极大地提高了计算机的并发度。虚拟页式存储管理，则是将进程所需空间划分为多个页面，内存中只存放当前所需页面，其余页面放入外存的管理方式。<br>然而，有利就有弊，虚拟页式存储管理减少了进程所需的内存空间，却也带来了运行时间变长这一缺点：进程运行过程中，不可避免地要把在外存中存放的一些信息和内存中已有的进行交换，由于外存的低速，这一步骤所花费的时间不可忽略。因而，采取尽量好的算法以减少读取外存的次数，也是相当有意义的事情。</p>
<h6 id="以上摘抄自百度百科"><a href="#以上摘抄自百度百科" class="headerlink" title="以上摘抄自百度百科"></a>以上摘抄自百度百科</h6><hr>
<h2 id="LruDiskCache在android的应用"><a href="#LruDiskCache在android的应用" class="headerlink" title="LruDiskCache在android的应用"></a>LruDiskCache在android的应用</h2><p><strong>通过查看universalimageloader源代码分析DiskLruCache。</strong></p>
<pre><code>下面是给出的DiskLruCache算法的注释：
</code></pre><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * This cache uses a journal file named "journal". A typical journal file</span><br><span class="line"> * looks like this:</span><br><span class="line"> *     libcore.io.DiskLruCache</span><br><span class="line"> *     1</span><br><span class="line"> *     100</span><br><span class="line"> *     2</span><br><span class="line"> *</span><br><span class="line"> *     CLEAN 3400330d1dfc7f3f7f4b8d4d803dfcf6 832 21054</span><br><span class="line"> *     DIRTY 335c4c6028171cfddfbaae1a9c313c52</span><br><span class="line"> *     CLEAN 335c4c6028171cfddfbaae1a9c313c52 3934 2342</span><br><span class="line"> *     REMOVE 335c4c6028171cfddfbaae1a9c313c52</span><br><span class="line"> *     DIRTY 1ab96a171faeeee38496d8b330771a7a</span><br><span class="line"> *     CLEAN 1ab96a171faeeee38496d8b330771a7a 1600 234</span><br><span class="line"> *     READ 335c4c6028171cfddfbaae1a9c313c52</span><br><span class="line"> *     READ 3400330d1dfc7f3f7f4b8d4d803dfcf6</span><br><span class="line"> *</span><br><span class="line"> * The first five lines of the journal form its header. They are the</span><br><span class="line"> * constant string "libcore.io.DiskLruCache", the disk cache's version,</span><br><span class="line"> * the application's version, the value count, and a blank line.</span><br><span class="line"> *</span><br><span class="line"> * Each of the subsequent lines in the file is a record of the state of a</span><br><span class="line"> * cache entry. Each line contains space-separated values: a state, a key,</span><br><span class="line"> * and optional state-specific values.</span><br><span class="line"> *   o DIRTY lines track that an entry is actively being created or updated.</span><br><span class="line"> *     Every successful DIRTY action should be followed by a CLEAN or REMOVE</span><br><span class="line"> *     action. DIRTY lines without a matching CLEAN or REMOVE indicate that</span><br><span class="line"> *     temporary files may need to be deleted.</span><br><span class="line"> *   o CLEAN lines track a cache entry that has been successfully published</span><br><span class="line"> *     and may be read. A publish line is followed by the lengths of each of</span><br><span class="line"> *     its values.</span><br><span class="line"> *   o READ lines track accesses for LRU.</span><br><span class="line"> *   o REMOVE lines track entries that have been deleted.</span><br><span class="line"> *</span><br><span class="line"> * The journal file is appended to as cache operations occur. The journal may</span><br><span class="line"> * occasionally be compacted by dropping redundant lines. A temporary file named</span><br><span class="line"> * "journal.tmp" will be used during compaction; that file should be deleted if</span><br><span class="line"> * it exists when the cache is opened.</span><br><span class="line"> */</span></span><br></pre></td></tr></table></figure>
<p><strong>缓存是存放在一个journal的文件里面进行对文件的管理（ <code>DIRTY、CLEAN、REMOVE、READ</code> )格式可以参考上边的注释，说的很清楚。</strong></p>
<ul>
<li><p>DIRTY一行代表一个新的文件就要创建或更新,每一个成功的DIRTY创建完之后，都应该跟着一个CLEAN或者REMOVE，如果后面没有跟他们其中的一个，预示着这个文件需要删除。调用 <code>edit（String key, long expectedSequenceNumber）</code> 会写入。</p>
</li>
<li><p>CLEAN行说明该缓存文件已经正常缓存，用户可以读取了，后面跟随着文件的length，当调用 <code>completeEdit（Editor editor, boolean success）</code> 并且存储成功。</p>
</li>
<li><p>REMOVE说明文件已经被删除掉了，调用 <code>remove（String key)</code> 方法或者存储失败的时候。</p>
</li>
<li><p>READ说明文件已经被读取了，需调用 <code>get（String key）</code> 方法。</p>
</li>
</ul>
<pre><code>读取journer文件的方法如下：
</code></pre><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readJournal</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	StrictLineReader reader = <span class="keyword">new</span> StrictLineReader(<span class="keyword">new</span> FileInputStream(journalFile), Util.US_ASCII);</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		String magic = reader.readLine();</span><br><span class="line">		String version = reader.readLine();</span><br><span class="line">		String appVersionString = reader.readLine();</span><br><span class="line">		String valueCountString = reader.readLine();</span><br><span class="line">		String blank = reader.readLine();</span><br><span class="line">		<span class="keyword">if</span> (!MAGIC.equals(magic)</span><br><span class="line">				|| !VERSION_1.equals(version)</span><br><span class="line">				|| !Integer.toString(appVersion).equals(appVersionString)</span><br><span class="line">				|| !Integer.toString(valueCount).equals(valueCountString)</span><br><span class="line">				|| !<span class="string">""</span>.equals(blank)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"unexpected journal header: ["</span> + magic + <span class="string">", "</span> + version + <span class="string">", "</span></span><br><span class="line">					+ valueCountString + <span class="string">", "</span> + blank + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> lineCount = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				readJournalLine(reader.readLine());</span><br><span class="line">				lineCount++;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (EOFException endOfJournal) &#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		redundantOpCount = lineCount - lruEntries.size();</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		Util.closeQuietly(reader);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>内部存储单元 Entry</strong></p>
<pre><code>内部通过一个有序的LinkedHashMap保存lruEntries,Entry内部存储currentEditor进行对文件的处理。
</code></pre><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Lengths of this entry's files. */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span>[] lengths;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** True if this entry has ever been published. */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> readable;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The ongoing edit or null if this entry is not being edited. */</span></span><br><span class="line">	<span class="keyword">private</span> Editor currentEditor;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The sequence number of the most recently committed edit to this entry. */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> sequenceNumber;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">Entry</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.key = key;</span><br><span class="line">		<span class="keyword">this</span>.lengths = <span class="keyword">new</span> <span class="keyword">long</span>[valueCount];</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Edits the values for an entry. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Editor</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Entry entry;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span>[] written;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> hasErrors;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> committed;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">Editor</span><span class="params">(Entry entry)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.entry = entry;</span><br><span class="line">		<span class="keyword">this</span>.written = (entry.readable) ? <span class="keyword">null</span> : <span class="keyword">new</span> <span class="keyword">boolean</span>[valueCount];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Returns an unbuffered input stream to read the last committed value,</span><br><span class="line">	 * or null if no value has been committed.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> InputStream <span class="title">newInputStream</span><span class="params">(<span class="keyword">int</span> index)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (DiskLruCache.<span class="keyword">this</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (entry.currentEditor != <span class="keyword">this</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!entry.readable) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">new</span> FileInputStream(entry.getCleanFile(index));</span><br><span class="line">			&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Returns the last committed value as a string, or null if no value</span><br><span class="line">	 * has been committed.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">int</span> index)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		InputStream in = newInputStream(index);</span><br><span class="line">		<span class="keyword">return</span> in != <span class="keyword">null</span> ? inputStreamToString(in) : <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Returns a new unbuffered output stream to write the value at</span><br><span class="line">	 * &#123;<span class="doctag">@code</span> index&#125;. If the underlying output stream encounters errors</span><br><span class="line">	 * when writing to the filesystem, this edit will be aborted when</span><br><span class="line">	 * &#123;<span class="doctag">@link</span> #commit&#125; is called. The returned output stream does not throw</span><br><span class="line">	 * IOExceptions.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> OutputStream <span class="title">newOutputStream</span><span class="params">(<span class="keyword">int</span> index)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (DiskLruCache.<span class="keyword">this</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (entry.currentEditor != <span class="keyword">this</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!entry.readable) &#123;</span><br><span class="line">				written[index] = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			File dirtyFile = entry.getDirtyFile(index);</span><br><span class="line">			FileOutputStream outputStream;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				outputStream = <span class="keyword">new</span> FileOutputStream(dirtyFile);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">				<span class="comment">// Attempt to recreate the cache directory.</span></span><br><span class="line">				directory.mkdirs();</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					outputStream = <span class="keyword">new</span> FileOutputStream(dirtyFile);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (FileNotFoundException e2) &#123;</span><br><span class="line">					<span class="comment">// We are unable to recover. Silently eat the writes.</span></span><br><span class="line">					<span class="keyword">return</span> NULL_OUTPUT_STREAM;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> FaultHidingOutputStream(outputStream);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Sets the value at &#123;<span class="doctag">@code</span> index&#125; to &#123;<span class="doctag">@code</span> value&#125;. */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, String value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		Writer writer = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			writer = <span class="keyword">new</span> OutputStreamWriter(newOutputStream(index), Util.UTF_8);</span><br><span class="line">			writer.write(value);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			Util.closeQuietly(writer);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Commits this edit so it is visible to readers.  This releases the</span><br><span class="line">	 * edit lock so another edit may be started on the same key.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (hasErrors) &#123;</span><br><span class="line">			completeEdit(<span class="keyword">this</span>, <span class="keyword">false</span>);</span><br><span class="line">			remove(entry.key); <span class="comment">// The previous entry is stale.</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			completeEdit(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		committed = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Aborts this edit. This releases the edit lock so another edit may be</span><br><span class="line">	 * started on the same key.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">abort</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		completeEdit(<span class="keyword">this</span>, <span class="keyword">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">abortUnlessCommitted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!committed) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				abort();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException ignored) &#123;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">FaultHidingOutputStream</span> <span class="keyword">extends</span> <span class="title">FilterOutputStream</span> </span>&#123;</span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="title">FaultHidingOutputStream</span><span class="params">(OutputStream out)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">super</span>(out);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> oneByte)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				out.write(oneByte);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				hasErrors = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				out.write(buffer, offset, length);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				hasErrors = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				out.close();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				hasErrors = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				out.flush();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				hasErrors = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Snapshot主要是负责文件的获取内容</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** A snapshot of the values for an entry. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Snapshot</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> sequenceNumber;</span><br><span class="line">	<span class="keyword">private</span> File[] files;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> InputStream[] ins;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span>[] lengths;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="title">Snapshot</span><span class="params">(String key, <span class="keyword">long</span> sequenceNumber, File[] files, InputStream[] ins, <span class="keyword">long</span>[] lengths)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.key = key;</span><br><span class="line">		<span class="keyword">this</span>.sequenceNumber = sequenceNumber;</span><br><span class="line">		<span class="keyword">this</span>.files = files;</span><br><span class="line">		<span class="keyword">this</span>.ins = ins;</span><br><span class="line">		<span class="keyword">this</span>.lengths = lengths;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Returns an editor for this snapshot's entry, or null if either the</span><br><span class="line">	 * entry has changed since this snapshot was created or if another edit</span><br><span class="line">	 * is in progress.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Editor <span class="title">edit</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> DiskLruCache.<span class="keyword">this</span>.edit(key, sequenceNumber);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Returns file with the value for &#123;<span class="doctag">@code</span> index&#125;. */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> File <span class="title">getFile</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> files[index];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Returns the unbuffered stream with the value for &#123;<span class="doctag">@code</span> index&#125;. */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ins[index];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Returns the string value for &#123;<span class="doctag">@code</span> index&#125;. */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">int</span> index)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> inputStreamToString(getInputStream(index));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Returns the byte length of the value for &#123;<span class="doctag">@code</span> index&#125;. */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLength</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> lengths[index];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (InputStream in : ins) &#123;</span><br><span class="line">			Util.closeQuietly(in);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="那看我们如何应用DiskLruCache"><a href="#那看我们如何应用DiskLruCache" class="headerlink" title="那看我们如何应用DiskLruCache"></a>那看我们如何应用DiskLruCache</h2><pre><code>先看 LruDiskCache这个类很简单的实现 DiskCache 接口。
</code></pre><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Interface for disk cache</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@author</span> Sergey Tarasevich (nostra13[at]gmail[dot]com)</span><br><span class="line"> * <span class="doctag">@since</span> 1.9.2</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DiskCache</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Returns root directory of disk cache</span><br><span class="line">	 *</span><br><span class="line">	 * <span class="doctag">@return</span> Root directory of disk cache</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function">File <span class="title">getDirectory</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Returns file of cached image</span><br><span class="line">	 *</span><br><span class="line">	 * <span class="doctag">@param</span> imageUri Original image URI</span><br><span class="line">	 * <span class="doctag">@return</span> File of cached image or &lt;b&gt;null&lt;/b&gt; if image wasn't cached</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function">File <span class="title">get</span><span class="params">(String imageUri)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Saves image stream in disk cache.</span><br><span class="line">	 * Incoming image stream shouldn't be closed in this method.</span><br><span class="line">	 *</span><br><span class="line">	 * <span class="doctag">@param</span> imageUri    Original image URI</span><br><span class="line">	 * <span class="doctag">@param</span> imageStream Input stream of image (shouldn't be closed in this method)</span><br><span class="line">	 * <span class="doctag">@param</span> listener    Listener for saving progress, can be ignored if you don't use</span><br><span class="line">	 *                    &#123;<span class="doctag">@linkplain</span> com.nostra13.universalimageloader.core.listener.ImageLoadingProgressListener</span><br><span class="line">	 *                    progress listener&#125; in ImageLoader calls</span><br><span class="line">	 * <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if image was saved successfully; &lt;b&gt;false&lt;/b&gt; - if image wasn't saved in disk cache.</span><br><span class="line">	 * <span class="doctag">@throws</span> java.io.IOException</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">save</span><span class="params">(String imageUri, InputStream imageStream, IoUtils.CopyListener listener)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Saves image bitmap in disk cache.</span><br><span class="line">	 *</span><br><span class="line">	 * <span class="doctag">@param</span> imageUri Original image URI</span><br><span class="line">	 * <span class="doctag">@param</span> bitmap   Image bitmap</span><br><span class="line">	 * <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if bitmap was saved successfully; &lt;b&gt;false&lt;/b&gt; - if bitmap wasn't saved in disk cache.</span><br><span class="line">	 * <span class="doctag">@throws</span> IOException</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">save</span><span class="params">(String imageUri, Bitmap bitmap)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Removes image file associated with incoming URI</span><br><span class="line">	 *</span><br><span class="line">	 * <span class="doctag">@param</span> imageUri Image URI</span><br><span class="line">	 * <span class="doctag">@return</span> &lt;b&gt;true&lt;/b&gt; - if image file is deleted successfully; &lt;b&gt;false&lt;/b&gt; - if image file doesn't exist for</span><br><span class="line">	 * incoming URI or image file can't be deleted.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(String imageUri)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Closes disk cache, releases resources. */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Clears disk cache. */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>具体实现该接口代码</strong></p>
<pre><code>通过get，save，remove 对缓存文件进行读写。
</code></pre><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LruDiskCache</span> <span class="keyword">implements</span> <span class="title">DiskCache</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> File <span class="title">get</span><span class="params">(String imageUri)</span> </span>&#123;</span><br><span class="line">		DiskLruCache.Snapshot snapshot = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			snapshot = cache.get(getKey(imageUri));</span><br><span class="line">			<span class="keyword">return</span> snapshot == <span class="keyword">null</span> ? <span class="keyword">null</span> : snapshot.getFile(<span class="number">0</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			L.e(e);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (snapshot != <span class="keyword">null</span>) &#123;</span><br><span class="line">				snapshot.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">(String imageUri, InputStream imageStream, IoUtils.CopyListener listener)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		DiskLruCache.Editor editor = cache.edit(getKey(imageUri));</span><br><span class="line">		<span class="keyword">if</span> (editor == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		OutputStream os = <span class="keyword">new</span> BufferedOutputStream(editor.newOutputStream(<span class="number">0</span>), bufferSize);</span><br><span class="line">		<span class="keyword">boolean</span> copied = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			copied = IoUtils.copyStream(imageStream, os, listener, bufferSize);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IoUtils.closeSilently(os);</span><br><span class="line">			<span class="keyword">if</span> (copied) &#123;</span><br><span class="line">				editor.commit();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				editor.abort();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> copied;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">(String imageUri, Bitmap bitmap)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		DiskLruCache.Editor editor = cache.edit(getKey(imageUri));</span><br><span class="line">		<span class="keyword">if</span> (editor == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		OutputStream os = <span class="keyword">new</span> BufferedOutputStream(editor.newOutputStream(<span class="number">0</span>), bufferSize);</span><br><span class="line">		<span class="keyword">boolean</span> savedSuccessfully = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			savedSuccessfully = bitmap.compress(compressFormat, compressQuality, os);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			IoUtils.closeSilently(os);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (savedSuccessfully) &#123;</span><br><span class="line">			editor.commit();</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			editor.abort();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> savedSuccessfully;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(String imageUri)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> cache.remove(getKey(imageUri));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			L.e(e);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>当通过get方法获取缓存文件时，会判断journal是否重建。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * We only rebuild the journal when it will halve the size of the journal</span><br><span class="line"> * and eliminate at least 2000 ops.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">journalRebuildRequired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> redundantOpCompactThreshold = <span class="number">2000</span>;</span><br><span class="line">	<span class="keyword">return</span> redundantOpCount &gt;= redundantOpCompactThreshold <span class="comment">//</span></span><br><span class="line">			&amp;&amp; redundantOpCount &gt;= lruEntries.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>如果需要重建会调用下面的方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Creates a new journal that omits redundant information. This replaces the</span><br><span class="line"> * current journal if it exists.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">rebuildJournal</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (journalWriter != <span class="keyword">null</span>) &#123;</span><br><span class="line">		journalWriter.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Writer writer = <span class="keyword">new</span> BufferedWriter(</span><br><span class="line">			<span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(journalFileTmp), Util.US_ASCII));</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		writer.write(MAGIC);</span><br><span class="line">		writer.write(<span class="string">"\n"</span>);</span><br><span class="line">		writer.write(VERSION_1);</span><br><span class="line">		writer.write(<span class="string">"\n"</span>);</span><br><span class="line">		writer.write(Integer.toString(appVersion));</span><br><span class="line">		writer.write(<span class="string">"\n"</span>);</span><br><span class="line">		writer.write(Integer.toString(valueCount));</span><br><span class="line">		writer.write(<span class="string">"\n"</span>);</span><br><span class="line">		writer.write(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (Entry entry : lruEntries.values()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (entry.currentEditor != <span class="keyword">null</span>) &#123;</span><br><span class="line">				writer.write(DIRTY + <span class="string">' '</span> + entry.key + <span class="string">'\n'</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				writer.write(CLEAN + <span class="string">' '</span> + entry.key + entry.getLengths() + <span class="string">'\n'</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		writer.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (journalFile.exists()) &#123;</span><br><span class="line">		renameTo(journalFile, journalFileBackup, <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	renameTo(journalFileTmp, journalFile, <span class="keyword">false</span>);</span><br><span class="line">	journalFileBackup.delete();</span><br><span class="line"></span><br><span class="line">	journalWriter = <span class="keyword">new</span> BufferedWriter(</span><br><span class="line">			<span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(journalFile, <span class="keyword">true</span>), Util.US_ASCII));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>而且还会通过size和fileCount对文件进行清理 <code>trimToSize（）</code> and <code>trimToFileCount（）</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (size &gt; maxSize) &#123;</span><br><span class="line">		Map.Entry&lt;String, Entry&gt; toEvict = lruEntries.entrySet().iterator().next();</span><br><span class="line">		remove(toEvict.getKey());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">trimToFileCount</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (fileCount &gt; maxFileCount) &#123;</span><br><span class="line">		Map.Entry&lt;String, Entry&gt; toEvict = lruEntries.entrySet().iterator().next();</span><br><span class="line">		remove(toEvict.getKey());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="这样universalimageloader的DiskLruCache分析到这-有什么不懂的可以联系我"><a href="#这样universalimageloader的DiskLruCache分析到这-有什么不懂的可以联系我" class="headerlink" title="这样universalimageloader的DiskLruCache分析到这,有什么不懂的可以联系我"></a>这样universalimageloader的DiskLruCache分析到这,有什么不懂的可以<a href="/about">联系我</a></h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://wangdongen.cn/2016/06/29/DiskLruCache/" data-id="ciq11wahb0001cma4oo0razbo" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LruCache/">LruCache</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cache/">cache</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/06/21/use-SoftReference-and-WeakReference/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">Java 如何有效地避免OOM：善于利用软引用和弱引用</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-DiskLruCache" data-title="UIL之DiskLruCache 源码分析" data-url="http://wangdongen.cn/2016/06/29/DiskLruCache/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'smallsilver'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>
  
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Mot-clés</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LruCache/">LruCache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cache/">cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory/">memory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图片框架/">图片框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nuage de mot-clés</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/LruCache/" style="font-size: 10px;">LruCache</a> <a href="/tags/cache/" style="font-size: 10px;">cache</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/memory/" style="font-size: 10px;">memory</a> <a href="/tags/vim/" style="font-size: 10px;">vim</a> <a href="/tags/图片框架/" style="font-size: 10px;">图片框架</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/06/29/DiskLruCache/">UIL之DiskLruCache 源码分析</a>
          </li>
        
          <li>
            <a href="/2016/06/21/use-SoftReference-and-WeakReference/">Java 如何有效地避免OOM：善于利用软引用和弱引用</a>
          </li>
        
          <li>
            <a href="/2016/06/19/UniversalImageLoader/">图片框架系列（一）UIL介绍篇</a>
          </li>
        
          <li>
            <a href="/2016/06/15/vim入门基础/">Vim入门基础</a>
          </li>
        
          <li>
            <a href="/2016/06/13/Android源码设计模式/">Android源码设计模式分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    <div class="widget-wrap">
    <h3 class="widget-title">friend's blog</h3>
    <div class="widget">
    <ul class="entry"> 
      <li><a href="http://liugangqiang.com" title="e">小强</a></li> 
      <li><a href="http://note.dagger.cc" title="e">汪主席</a></li> 
    </ul> 
    </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 dongen_wang@163.com<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>